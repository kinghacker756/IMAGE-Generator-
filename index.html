<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Advanced AI Image Generator</title>
  <style>
    /* Compact advanced styling for a modern app */
    :root{
      --bg1:#0f172a; --bg2:#071032; --card:#0b1220; --accent:#7c5cff;
      --glass: rgba(255,255,255,0.04);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      background: radial-gradient(1200px 600px at 10% 10%, rgba(124,92,255,0.12), transparent),
                  linear-gradient(180deg,var(--bg1),var(--bg2));
      color:#e6eef8;
      -webkit-font-smoothing:antialiased;
    }
    .wrap{max-width:1100px;margin:36px auto;padding:24px;display:grid;grid-template-columns:1fr 420px;gap:28px}
    header{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;gap:12px}
    h1{font-size:1.6rem;margin:0;background:linear-gradient(90deg,#fff,#a8c0ff);-webkit-background-clip:text;color:transparent;font-weight:700}
    .sub{color:rgba(230,238,248,0.7);font-size:0.95rem}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:14px;padding:18px;border:1px solid rgba(255,255,255,0.04);box-shadow: 0 8px 30px rgba(3,6,23,0.6)}
    .left{display:flex;flex-direction:column;gap:12px}
    label{font-size:0.9rem;color:rgba(230,238,248,0.9);display:block;margin-bottom:8px;font-weight:600}
    textarea{width:100%;min-height:140px;padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;resize:vertical}
    .controls{display:flex;gap:10px;flex-wrap:wrap}
    .chip{padding:8px 12px;border-radius:999px;background:var(--glass);cursor:pointer;font-weight:600;border:1px solid transparent}
    .chip.active{background:linear-gradient(90deg,var(--accent),#39d6d6);color:#061123;box-shadow:0 8px 20px rgba(124,92,255,0.12)}
    .row{display:flex;gap:10px;align-items:center}
    .btn{
      background:linear-gradient(90deg,var(--accent),#39d6d6);border:none;padding:12px 16px;border-radius:10px;color:#061123;font-weight:700;cursor:pointer;box-shadow:0 8px 30px rgba(7,10,30,0.6);
    }
    .btn[disabled]{opacity:0.6;cursor:not-allowed}
    .right{display:flex;flex-direction:column;gap:12px}
    .preview{min-height:360px;display:flex;align-items:center;justify-content:center;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);border:1px dashed rgba(255,255,255,0.04);overflow:hidden;position:relative}
    .preview img{max-width:100%;max-height:100%;border-radius:8px;display:block}
    .meta{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:8px}
    .text-muted{color:rgba(230,238,248,0.6);font-size:0.9rem}
    .gallery{grid-column:1/-1;margin-top:18px;display:flex;gap:12px;overflow-x:auto;padding-bottom:6px}
    .thumb{min-width:120px;border-radius:8px;overflow:hidden;border:1px solid rgba(255,255,255,0.04);cursor:pointer}
    .thumb img{display:block;width:100%;height:80px;object-fit:cover}
    .messages{min-height:28px}
    @media (max-width:980px){
      .wrap{grid-template-columns:1fr; padding:18px}
      .right{order:-1}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Advanced Image Generator</h1>
        <div class="sub">Photorealistic, artistic or abstract — build images with fine-grain controls and a secure backend</div>
      </div>
      <div class="text-muted">Tip: press <strong>Ctrl+Enter</strong> to generate</div>
    </header>

    <section class="card left">
      <div>
        <label for="prompt">Image prompt</label>
        <textarea id="prompt" placeholder="Describe the scene (characters, environment, mood, lighting, camera style)..."></textarea>
      </div>

      <div>
        <label>Style</label>
        <div class="controls" id="styles">
          <div class="chip active" data-style="realistic">Realistic</div>
          <div class="chip" data-style="artistic">Artistic</div>
          <div class="chip" data-style="cartoon">Cartoon</div>
          <div class="chip" data-style="abstract">Abstract</div>
        </div>
      </div>

      <div>
        <label>Size</label>
        <div class="controls" id="sizes">
          <div class="chip" data-size="256x256">256</div>
          <div class="chip active" data-size="512x512">512</div>
          <div class="chip" data-size="1024x1024">1024</div>
        </div>
      </div>

      <div class="row">
        <button id="generate" class="btn">Generate Image</button>
        <div id="messages" class="messages text-muted"></div>
      </div>
    </section>

    <aside class="card right">
      <div class="preview" id="preview">
        <div class="text-muted">Your generated image will appear here</div>
      </div>

      <div class="meta">
        <button id="downloadBtn" class="btn" style="background:#2ecc71">Download</button>
        <button id="shareBtn" class="btn" style="background:#17a2b8">Share</button>
        <div id="promptPreview" class="text-muted" style="margin-left:12px"></div>
      </div>
    </aside>

    <div class="gallery" id="gallery"></div>
  </div>

  <script>
    // Frontend logic
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const promptEl = $("#prompt");
    const preview = $("#preview");
    const generateBtn = $("#generate");
    const messages = $("#messages");
    const gallery = $("#gallery");
    const downloadBtn = $("#downloadBtn");
    const shareBtn = $("#shareBtn");
    const promptPreview = $("#promptPreview");

    let currentImage = null;
    let recent = JSON.parse(localStorage.getItem("aig_recent") || "[]");

    function setMessage(text, isError=false){
      messages.textContent = text;
      messages.style.color = isError ? "#ffb3b3" : "inherit";
    }

    function updateGallery(){
      gallery.innerHTML = "";
      recent.slice(0,12).forEach(item => {
        const div = document.createElement("div");
        div.className = "thumb";
        div.innerHTML = `<img src="${item.url}" alt="thumb">`;
        div.addEventListener("click", ()=> displayImage(item));
        gallery.appendChild(div);
      });
    }

    function displayImage(item){
      preview.innerHTML = `<img src="${item.url}" alt="generated">`;
      currentImage = item;
      promptPreview.textContent = item.prompt.length > 80 ? item.prompt.slice(0,80)+"…" : item.prompt;
    }

    // style and size selection
    document.getElementById("styles").addEventListener("click", (e) => {
      if(!e.target.classList.contains("chip")) return;
      $$(".chip").forEach(c=>c.classList.remove("active"));
      e.target.classList.add("active");
    });

    document.getElementById("sizes").addEventListener("click", (e) => {
      if(!e.target.classList.contains("chip")) return;
      $$("#sizes .chip").forEach(c=>c.classList.remove("active"));
      e.target.classList.add("active");
    });

    // generate
    async function generate(){
      const prompt = promptEl.value.trim();
      if(!prompt){ setMessage("Please enter a prompt.", true); return; }
      setMessage("Generating…");
      generateBtn.disabled = true;

      const style = document.querySelector("#styles .chip.active").dataset.style;
      const size = document.querySelector("#sizes .chip.active").dataset.size;

      try {
        const resp = await fetch("/api/generate-image", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt, style, size })
        });

        const data = await resp.json();
        if(!resp.ok){
          console.error(data);
          setMessage("Failed: " + (data?.error?.message || data?.error || "unknown"), true);
          return;
        }

        // server returns { url } or { b64_json }
        let imageUrl = data.url;
        if(!imageUrl && data.b64_json){
          imageUrl = "data:image/png;base64," + data.b64_json;
        }
        if(!imageUrl){
          setMessage("No image returned from server.", true);
          return;
        }

        const item = { url: imageUrl, prompt, timestamp: new Date().toISOString() };
        recent.unshift(item);
        recent = recent.slice(0,12);
        localStorage.setItem("aig_recent", JSON.stringify(recent));
        updateGallery();
        displayImage(item);
        setMessage("Image generated ✓");
      } catch(err){
        console.error(err);
        setMessage("Network or server error.", true);
      } finally {
        generateBtn.disabled = false;
      }
    }

    generateBtn.addEventListener("click", generate);
    promptEl.addEventListener("keydown", (e) => {
      if(e.ctrlKey && e.key === "Enter"){ generate(); }
    });

    downloadBtn.addEventListener("click", () => {
      if(!currentImage) { setMessage("No image to download.", true); return; }
      const a = document.createElement("a");
      a.href = currentImage.url;
      a.download = `ai-image-${Date.now()}.png`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setMessage("Download started.");
    });

    shareBtn.addEventListener("click", async () => {
      if(!currentImage){ setMessage("No image to share.", true); return; }
      try {
        if(navigator.share){
          await navigator.share({ title: "AI Image", text: currentImage.prompt, url: currentImage.url });
        } else {
          await navigator.clipboard.writeText(currentImage.url);
          setMessage("Image URL copied to clipboard.");
        }
      } catch(err){
        setMessage("Share failed.", true);
      }
    });

    updateGallery();
    if(recent.length) displayImage(recent[0]);
  </script>
</body>
</html>
